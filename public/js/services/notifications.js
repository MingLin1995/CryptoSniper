// public/js/services/notifications.js
import {
  checkSubscriptionStatus,
  updateToggleButtonText,
  toggleNotification,
} from "../viewHandlers.js";

let currentNotificationMethod;

// 綁定事件到所有帶有特定data-toggle的圖片
document.querySelectorAll('img[data-toggle="modal"]').forEach((img) => {
  img.addEventListener("click", function () {
    // 根據點擊的圖片設置通知方式
    currentNotificationMethod = this.getAttribute("data-notification-method");
    // 根據選擇的通知方式顯示相應的視窗
    let targetModal = this.getAttribute("data-target");
    $(targetModal).modal("show");
  });
});

// 圖片
const notificationImage = document.getElementById("NotificationPermissio-web");

// 點擊圖片時，請求通知許可
notificationImage.addEventListener("click", async function () {
  await onClick();
  await checkSubscriptionStatus(currentNotificationMethod);
});

// 通知許可權請求
async function requestNotificationPermission() {
  const permission = await Notification.requestPermission();
  if (permission !== "granted") {
    //console.log("用戶拒絕了通知許可權");
    return false;
  }
  //console.log("通知許可權獲得成功");
  return true;
}

//按鈕
const toggleSubscriptionButton = document.getElementById("toggle-subscription");

// 按鈕點擊時處理訂閱邏輯
toggleSubscriptionButton.addEventListener("click", async function () {
  toggleNotification(currentNotificationMethod);
});

// 點擊時的許可通知
async function onClick() {
  const hasPermission = await requestNotificationPermission();
  if (!hasPermission) {
    alert("未獲得您的通知許可權，請至瀏覽器設定開啟通知許可權");
    window.location.href = "/";
    return;
  }
  const registration = await registerServiceWorker();
  if (registration) {
    await manageSubscription(registration);
  }
}

// 註冊 service worker
async function registerServiceWorker() {
  try {
    const registration = await navigator.serviceWorker.register(
      "/js/services/service-worker.js"
    );
    //console.log("Service Worker 註冊成功");
    return registration;
  } catch (error) {
    console.error("Service Worker 註冊失敗", error);
    return null;
  }
}

// 初始化函數
async function init() {
  if (!checkBrowserSupport()) {
    alert("此瀏覽器不支持推送通知。");
    return;
  }
  await registerServiceWorker();
}

// 檢查瀏覽器支持
function checkBrowserSupport() {
  if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
    console.warn("Push messaging is not supported");
    return false;
  }
  return true;
}

init();

document
  .getElementById("targetPriceForm")
  .addEventListener("submit", async function (event) {
    event.preventDefault();

    const hasPermission = await requestNotificationPermission();
    if (!hasPermission) {
      alert("未獲得您的通知許可權，請至瀏覽器設定開啟通知許可權");
      window.location.href = "/";

      return;
    }

    const button = document.getElementById("toggle-subscription").textContent;
    if (button == "開啟 Web 到價通知") {
      alert("尚未開啟到價通知！");
      return;
    }

    const symbol = document.getElementById("symbol-Notification").value; // 獲取使用者輸入的幣種
    const targetPrice = document.getElementById(
      "targetPrice-Notification"
    ).value;
    const token = localStorage.getItem("token");

    // 使用先前選擇的通知方式
    const notificationMethod = currentNotificationMethod;

    fetch("/api/track", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: token,
      },
      body: JSON.stringify({
        symbol: symbol,
        targetPrice: targetPrice,
        notificationMethod: notificationMethod,
      }),
    })
      .then((response) => {
        if (!response.ok) {
          const errorResponse = response.json();
          if (errorResponse.error === "jwt expired") {
            window.location.href = "/";
            return;
          }
          throw new Error("無法獲取訂閱狀態");
        }
      })
      .then((data) => {
        //console.log(data);
        alert("到價通知設定成功！");
      })
      .catch((error) => {
        console.error("Error:", error);
      });
  });

// 主要訂閱邏輯
async function manageSubscription(registration) {
  if (!registration) {
    console.log("Service Worker 註冊不成功，無法管理訂閱");
    return;
  }

  let subscription = await registration.pushManager.getSubscription();
  if (!subscription) {
    console.log("test");
    // 沒有訂閱，創建新的訂閱
    subscription = await subscribeUser(registration);
  } else {
    // 已經有訂閱，可以選擇更新後端信息或直接返回
    //console.log("已經訂閱");
    // 可以選擇在此處調用 sendSubscriptionToBackend 來更新後端資訊
  }
}

async function subscribeUser(registration) {
  try {
    const applicationServerKey = urlB64ToUint8Array(
      "BOJp-4zvWlggd-KBzFdjO1Uy5lcfiO-h_1exi9I0Ba6yWiAJVZb6Z0EDVcMC8pOKDec-9dS0iNLMuti7rwARARM"
    );
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: applicationServerKey,
    });

    // 將訂閱詳情發送到後端
    await sendSubscriptionToBackend(subscription);

    console.log("用戶訂閱成功");
    updateToggleButtonText(true);
  } catch (error) {
    console.error("用戶訂閱失敗", error);
    updateToggleButtonText(false);
  }
}

// 輔助函數將Base64字符串轉換為Uint8Array
function urlB64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");

  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);

  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

// 將訂閱詳情發送到後端
async function sendSubscriptionToBackend(subscription) {
  const token = localStorage.getItem("token");

  // 將訂閱對象轉換為適合發送的格式
  const subscriptionData = JSON.stringify(subscription);

  try {
    await fetch("/api/subscription/subscribe", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: token,
      },
      body: subscriptionData,
    });
    //console.log("訂閱詳情已發送到後端");
  } catch (error) {
    console.error("發送訂閱詳情到後端失敗", error);
  }
}
